<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>éŸ³å£°èªè­˜ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚²ãƒ¼ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 20px;
            max-width: 800px;
            width: 100%;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                align-items: flex-start;
                padding-top: 20px;
            }
            
            .container {
                padding: 15px;
                border-radius: 15px;
                max-height: 95vh;
                width: 95%;
            }
            
            h1 {
                font-size: 1.8em !important;
                margin-bottom: 20px !important;
            }
            
            h2 {
                font-size: 1.5em !important;
                margin-bottom: 15px !important;
            }
            
            .question-display {
                font-size: 1.8em !important;
                padding: 15px !important;
                margin: 20px 0 !important;
                min-height: 60px !important;
                line-height: 1.2;
            }
            
            .recognition-display {
                font-size: 1.4em !important;
                padding: 15px !important;
                margin: 15px 0 !important;
                min-height: 50px !important;
            }
            
            .mic-button {
                width: 70px !important;
                height: 70px !important;
                font-size: 20px !important;
                margin: 15px !important;
            }
            
            .btn {
                padding: 12px 20px !important;
                font-size: 16px !important;
                margin: 8px !important;
            }
            
            .game-info {
                flex-direction: column !important;
                gap: 10px;
            }
            
            .info-item {
                margin: 5px 0 !important;
                padding: 10px !important;
                font-size: 1em !important;
            }
            
            .debug-info {
                padding: 10px !important;
                margin: 15px 0 !important;
            }
            
            .debug-section {
                margin: 8px 0 !important;
            }
            
            .debug-section strong {
                font-size: 0.9em;
            }
            
            .debug-section div {
                padding: 8px !important;
                font-size: 0.9em !important;
                margin: 3px 0 !important;
            }
            
            input[type="text"] {
                width: 80% !important;
                padding: 12px !important;
                font-size: 16px !important;
            }
            
            .instructions {
                padding: 15px !important;
                margin: 15px 0 !important;
                font-size: 0.9em;
                line-height: 1.4;
            }
            
            .instructions h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
            
            .instructions ul {
                text-align: left;
            }
            
            .instructions li {
                margin: 5px 0;
            }
            
            .results-summary {
                padding: 15px !important;
                margin: 15px 0 !important;
            }
            
            .final-score {
                font-size: 2.2em !important;
                margin: 15px 0 !important;
            }
            
            .result-item {
                padding: 8px !important;
                margin: 3px 0 !important;
                font-size: 0.9em;
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            .result-item div:last-child {
                text-align: left;
                margin-top: 5px;
            }
        }

        /* éå¸¸ã«å°ã•ãªã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œ */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
                width: 98%;
            }
            
            h1 {
                font-size: 1.5em !important;
            }
            
            .question-display {
                font-size: 1.5em !important;
                padding: 10px !important;
            }
            
            .recognition-display {
                font-size: 1.2em !important;
                padding: 10px !important;
            }
            
            .mic-button {
                width: 60px !important;
                height: 60px !important;
                font-size: 18px !important;
            }
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .input-group {
            margin: 20px 0;
        }

        input[type="text"] {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation;
        }

        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .mic-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 24px;
            margin: 20px;
            touch-action: manipulation;
        }

        .mic-button.recording {
            background: linear-gradient(45deg, #51cf66, #40c057);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .question-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .recognition-display {
            font-size: 2em;
            margin: 20px 0;
            padding: 20px;
            background: #f1f3f4;
            border-radius: 15px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .char {
            margin: 0 2px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .char.correct {
            background-color: #4CAF50;
            color: white;
        }

        .char.incorrect {
            background-color: #f44336;
            color: white;
        }

        .char.pending {
            background-color: #ddd;
            color: #666;
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            font-size: 1.2em;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            margin: 0 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .mic-level {
            width: 100%;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .mic-level-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.1s;
        }

        .test-status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
        }

        .test-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .test-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .results-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .final-score {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .instructions {
            text-align: left;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            line-height: 1.6;
        }

        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff6b6b;
        }

        .debug-info {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .debug-section {
            margin: 10px 0;
        }

        .debug-section strong {
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="start-screen" class="screen active">
            <h1>ğŸ¤ éŸ³å£°èªè­˜ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
            <div class="instructions">
                <h3>ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹ï¼š</h3>
                <ul>
                    <li>è¡¨ç¤ºã•ã‚ŒãŸãŠé¡Œã‚’æ­£ç¢ºã«ç™ºå£°ã—ã¦ãã ã•ã„</li>
                    <li>20å•ä¸­15å•ãŒãƒ©ãƒ³ãƒ€ãƒ ã§å‡ºé¡Œã•ã‚Œã¾ã™</li>
                    <li>æ­£ç¢ºæ€§ã¨é€Ÿã•ã§å¾—ç‚¹ãŒæ±ºã¾ã‚Šã¾ã™</li>
                    <li>ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦éŸ³å£°å…¥åŠ›é–‹å§‹ã§ã™</li>
                </ul>
            </div>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›" maxlength="20">
            </div>
            <button class="btn" onclick="startMicTest()">ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆã¸</button>
        </div>

        <!-- ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”»é¢ -->
        <div id="mic-test-screen" class="screen">
            <h2>ğŸ¤ ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆ</h2>
            <p>ã€Œãƒ†ã‚¹ãƒˆã€ã¨è¨€ã£ã¦ãƒã‚¤ã‚¯ã®å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
            
            <div class="test-status" id="test-status">
                ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€Œãƒ†ã‚¹ãƒˆã€ã¨è¨€ã£ã¦ãã ã•ã„
            </div>
            
            <div class="mic-level">
                <div class="mic-level-bar" id="mic-level-bar"></div>
            </div>
            <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                ãƒã‚¤ã‚¯éŸ³é‡ãƒ¬ãƒ™ãƒ«: <span id="mic-level-text">0%</span>
            </div>
            
            <button class="mic-button" id="test-mic-btn">ğŸ¤</button>
            
            <div class="recognition-display" id="test-recognition">
                éŸ³å£°èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
            
            <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="debug-info">
                <h4>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h4>
                <div class="debug-section">
                    <strong>èªè­˜ã•ã‚ŒãŸè¨€è‘‰ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰:</strong>
                    <div id="debug-interim" style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 5px 0; min-height: 30px; font-style: italic;">
                        ã¾ã éŸ³å£°èªè­˜ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“
                    </div>
                </div>
                <div class="debug-section">
                    <strong>ç¢ºå®šã•ã‚ŒãŸè¨€è‘‰:</strong>
                    <div id="debug-final" style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 5px 0; min-height: 30px; font-weight: bold;">
                        ã¾ã ç¢ºå®šã•ã‚ŒãŸè¨€è‘‰ã¯ã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>
                <div class="debug-section">
                    <strong>éŸ³å£°èªè­˜ã®çŠ¶æ…‹:</strong>
                    <div id="debug-status" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 5px 0; min-height: 30px;">
                        å¾…æ©Ÿä¸­
                    </div>
                </div>
                <div class="debug-section">
                    <strong>ãƒã‚¤ã‚¯æ¥ç¶šçŠ¶æ³:</strong>
                    <div id="debug-mic-status" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 5px 0; min-height: 30px;">
                        æœªæ¥ç¶š
                    </div>
                </div>
                <div class="debug-section">
                    <strong>æ“ä½œã‚¬ã‚¤ãƒ‰:</strong>
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 5px 0; font-size: 0.9em;">
                        ğŸ“¢ ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’<strong>1å›ã ã‘</strong>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€<strong>3ç§’å¾…ã£ã¦ã‹ã‚‰</strong>ã€Œãƒ†ã‚¹ãƒˆã€ã¨è¨€ã£ã¦ãã ã•ã„
                    </div>
                </div>
            </div>
            
            <button class="btn" id="start-game-btn" onclick="startGame()" disabled>ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            <button class="btn" onclick="goToStart()">æˆ»ã‚‹</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="screen">
            <div class="game-info">
                <div class="info-item">
                    <strong>å•é¡Œ <span id="current-question">1</span>/15</strong>
                </div>
                <div class="info-item">
                    <strong>ã‚¹ã‚³ã‚¢: <span id="current-score">0</span>ç‚¹</strong>
                </div>
                <div class="info-item">
                    <strong class="timer">æ™‚é–“: <span id="timer">15</span>ç§’</strong>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div class="question-display" id="question-text">
                å•é¡ŒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>

            <button class="mic-button" id="game-mic-btn" onclick="startRecording()">ğŸ¤</button>

            <div class="recognition-display" id="recognition-text">
                éŸ³å£°èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>

            <!-- ã‚²ãƒ¼ãƒ ä¸­ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
            <div class="debug-info" style="margin-top: 20px;">
                <div class="debug-section">
                    <strong>PCãŒèãå–ã£ãŸè¨€è‘‰:</strong>
                    <div id="game-debug-speech" style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 5px 0; min-height: 30px;">
                        éŒ²éŸ³é–‹å§‹å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
            </div>

            <button class="btn" onclick="skipQuestion()">ã‚¹ã‚­ãƒƒãƒ—</button>
            <button class="btn" onclick="endGame()">ã‚²ãƒ¼ãƒ çµ‚äº†</button>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="result-screen" class="screen">
            <h2>ğŸ† ã‚²ãƒ¼ãƒ çµæœ</h2>
            
            <div class="final-score" id="final-score">0</div>
            
            <div class="results-summary">
                <h3><span id="player-result-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</span>ã•ã‚“ã®çµæœ</h3>
                <p>æ­£è§£ç‡: <span id="accuracy-rate">0</span>%</p>
                <p>å¹³å‡å›ç­”æ™‚é–“: <span id="average-time">0</span>ç§’</p>
                <p>å®Œäº†å•é¡Œæ•°: <span id="completed-questions">0</span>/15å•</p>
            </div>

            <div id="detailed-results"></div>

            <button class="btn" onclick="restartGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
            <button class="btn" onclick="goToStart()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // ====== å•é¡Œãƒ‡ãƒ¼ã‚¿è¨­å®šã‚¨ãƒªã‚¢ ======
        const QUESTIONS = [
            { id: 1, text: "æ ªå¼ä¼šç¤¾ä¸‰æ²³å±‹ã‚€ã‚‰ã›ã¾ã•ã‚ˆã—", category: "ä¼šç¤¾é–¢é€£", difficulty: "hard", baseScore: 100 },
            { id: 2, text: "ã„ã‘ã‚‹ã£ã¦", category: "æ—¥å¸¸ä¼šè©±", difficulty: "easy", baseScore: 30 },
            { id: 3, text: "ã‚„ã‚Œã‚‹ã£ã¦", category: "æ—¥å¸¸ä¼šè©±", difficulty: "easy", baseScore: 30 },
            { id: 4, text: "ãã®äººãŒä¸€ç•ªè¼ã‘ã‚‹å ´æ‰€ã§åƒãæœªæ¥ã‚’å®Ÿç¾ã™ã‚‹", category: "ä¼æ¥­ç†å¿µ", difficulty: "hard", baseScore: 95 },
            { id: 5, text: "ã¿ã‚“ãªã§æˆé•·ã™ã‚‹", category: "ä¼æ¥­ç†å¿µ", difficulty: "medium", baseScore: 50 },
            { id: 6, text: "ç†æƒ³ã‚’è¿½ã„ç¶šã‘ã‚‹", category: "ä¼æ¥­ç†å¿µ", difficulty: "medium", baseScore: 55 },
            { id: 7, text: "ç›¸æ‰‹ã®ç›®ç·šã«ç«‹ã¤", category: "ä¼æ¥­ç†å¿µ", difficulty: "medium", baseScore: 50 },
            { id: 8, text: "ãªã‚“ã§æ²–ç¸„ã„ã£ãŸã®ï¼Ÿ", category: "æ—¥å¸¸ä¼šè©±", difficulty: "easy", baseScore: 40 },
            { id: 9, text: "æ©Ÿç¨®å¤‰æ›´ã§ã™ã­ã€ãŠã†ã¡ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¯ä½•ã‚’ä½¿ã£ã¦ã¾ã™ã‹ï¼Ÿ", category: "å–¶æ¥­ãƒˆãƒ¼ã‚¯", difficulty: "hard", baseScore: 90 },
            { id: 10, text: "ä»Šã‚¹ãƒãƒ›ã®æ–™é‡‘ã„ãã‚‰ãã‚‰ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ", category: "å–¶æ¥­ãƒˆãƒ¼ã‚¯", difficulty: "medium", baseScore: 65 },
            { id: 11, text: "Laravelã¨Jquery", category: "æŠ€è¡“ç”¨èª", difficulty: "medium", baseScore: 60 },
            { id: 12, text: "ã‚³ãƒŸãƒ¥ãƒ•ã‚¡å…‰ãŒä¸€ç•ªå®‰ã„ã§ã™ã‚ˆ", category: "å–¶æ¥­ãƒˆãƒ¼ã‚¯", difficulty: "medium", baseScore: 60 },
            { id: 13, text: "ã“ã‚Œè¨€ãˆãŸã‚‰ãƒœãƒ¼ãƒŠã‚¹ã§ã‚‹ã‹ã‚‚ã‚ˆ", category: "æ—¥å¸¸ä¼šè©±", difficulty: "easy", baseScore: 45 },
            { id: 14, text: "æ ªå¼ä¼šç¤¾ä¸‰æ²³å±‹ã¯æœ€é«˜", category: "ä¼šç¤¾é–¢é€£", difficulty: "medium", baseScore: 55 },
            { id: 15, text: "æ—¥æœ¬ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¯ãªãœã“ã‚“ãªã«é€²æ­©ãŒé…ã„ã®ã‹", category: "æŠ€è¡“è­°è«–", difficulty: "hard", baseScore: 85 },
            { id: 16, text: "é–‹ç™ºã«å…¥ã‚‹ã®ã«é–‹ç™ºçµŒé¨“ãŒå¿…è¦ãªçŸ›ç›¾", category: "æŠ€è¡“è­°è«–", difficulty: "hard", baseScore: 80 },
            { id: 17, text: "ã„ã‚„ãƒ¼ã„ã‘ã‚‹ã£ã—ã‚‡", category: "æ—¥å¸¸ä¼šè©±", difficulty: "easy", baseScore: 35 },
            { id: 18, text: "ä¸‰æ²³å±‹ç¥å…·åº—", category: "ä¼šç¤¾é–¢é€£", difficulty: "medium", baseScore: 50 },
            { id: 19, text: "httpsã¨http", category: "æŠ€è¡“ç”¨èª", difficulty: "medium", baseScore: 55 },
            { id: 20, text: "ç¦åŸã•ã‚“ã®èº«é•·ã¯183ã‚»ãƒ³ãƒ", category: "é›‘å­¦", difficulty: "medium", baseScore: 60 }
        ];

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
        let gameState = {
            currentScreen: 'start',
            playerName: '',
            currentQuestion: 0,
            selectedQuestions: [],
            results: [],
            totalScore: 0,
            recognition: null,
            isRecording: false,
            questionStartTime: 0,
            timer: null,
            timeLeft: 15
        };

        // ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹
        function startMicTest() {
            const playerName = document.getElementById('player-name').value.trim();
            if (!playerName && gameState.currentScreen === 'start') {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (gameState.currentScreen === 'start') {
                gameState.playerName = playerName;
            }
            
            showScreen('mic-test-screen');
            setupMicTest();
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶ã¨ãƒ‡ãƒã‚¤ã‚¹ã®å¯¾å¿œãƒã‚§ãƒƒã‚¯
        function checkDeviceSupport() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(userAgent);
            const isAndroid = /android/.test(userAgent);
            const isMobile = /mobile|tablet/.test(userAgent) || isIOS || isAndroid;
            const isChrome = /chrome/.test(userAgent) && !/edge/.test(userAgent);
            const isSafari = /safari/.test(userAgent) && !/chrome/.test(userAgent);
            const isEdge = /edge/.test(userAgent);

            return {
                isIOS,
                isAndroid,
                isMobile,
                isChrome,
                isSafari,
                isEdge,
                speechSupported: 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window
            };
        }

        // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.error('Web Speech API not supported');
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            const deviceInfo = checkDeviceSupport();
            
            if (deviceInfo.isIOS) {
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'ja-JP';
                recognition.maxAlternatives = 1;
            } else {
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ja-JP';
                recognition.maxAlternatives = 1;
            }

            return recognition;
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            gameState.currentScreen = screenId;
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹
        function goToStart() {
            showScreen('start-screen');
            resetGameState();
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        function resetGameState() {
            gameState.currentQuestion = 0;
            gameState.results = [];
            gameState.totalScore = 0;
            gameState.isRecording = false;
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            if (gameState.recognition) {
                gameState.recognition.stop();
            }
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
        function updateDebugInfo(interim, final, status, micStatus) {
            document.getElementById('debug-interim').textContent = interim;
            document.getElementById('debug-final').textContent = final;
            document.getElementById('debug-status').textContent = status;
            document.getElementById('debug-mic-status').textContent = micStatus;
        }

        // ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupMicTest() {
            const testStatus = document.getElementById('test-status');
            const testRecognition = document.getElementById('test-recognition');
            const startGameBtn = document.getElementById('start-game-btn');
            const deviceInfo = checkDeviceSupport();

            updateDebugInfo('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºèªä¸­...', '', 'åˆæœŸåŒ–ä¸­', 'ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªä¸­');

            if (deviceInfo.isIOS) {
                testStatus.className = 'test-status';
                testStatus.textContent = 'iPhoneã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„...';
                
                gameState.recognition = initSpeechRecognition();
                if (!gameState.recognition) {
                    testStatus.className = 'test-status error';
                    testStatus.textContent = 'âŒ éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Safariãƒ–ãƒ©ã‚¦ã‚¶ã§ãŠè©¦ã—ãã ã•ã„ã€‚';
                    updateDebugInfo('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼', '', 'ã‚¨ãƒ©ãƒ¼: ã‚µãƒãƒ¼ãƒˆãªã—', 'Safariæ¨å¥¨');
                    return;
                }
            }

            testStatus.className = 'test-status';
            testStatus.textContent = 'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...';

            const constraints = {
                audio: {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: true,
                    sampleRate: 48000,
                    channelCount: 1,
                    volume: 1.0
                }
            };

            if (deviceInfo.isIOS) {
                constraints.audio = {
                    autoGainControl: true,
                    echoCancellation: false,
                    noiseSuppression: false
                };
            }

            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    console.log('ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ:', stream);
                    
                    const audioTrack = stream.getAudioTracks()[0];
                    if (audioTrack) {
                        const settings = audioTrack.getSettings();
                        console.log('ãƒã‚¤ã‚¯è¨­å®š:', settings);
                    }
                    
                    testStatus.textContent = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå–å¾—ã§ãã¾ã—ãŸã€‚ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚';
                    updateDebugInfo('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ', '', 'å¾…æ©Ÿä¸­', 'æ¥ç¶šæ¸ˆã¿');
                    
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        
                        if (deviceInfo.isIOS && audioContext.state === 'suspended') {
                            console.log('iOS AudioContext ã‚’ resume ã—ã¾ã™');
                            audioContext.resume();
                        }
                        
                        const analyser = audioContext.createAnalyser();
                        const microphone = audioContext.createMediaStreamSource(stream);
                        const gainNode = audioContext.createGain();
                        gainNode.gain.value = 2.0; // å¢—å¹…ã‚’2å€ã«èª¿æ•´ï¼ˆ3å€ã¯éå‰°ã ã£ãŸï¼‰
                        
                        microphone.connect(gainNode);
                        gainNode.connect(analyser);

                        analyser.fftSize = 2048;
                        analyser.smoothingTimeConstant = 0.1;
                        const bufferLength = analyser.frequencyBinCount;
                        const dataArray = new Uint8Array(bufferLength);

                        function updateMicLevel() {
                            if (gameState.currentScreen !== 'mic-test-screen') {
                                stream.getTracks().forEach(track => track.stop());
                                audioContext.close();
                                return;
                            }
                            
                            analyser.getByteTimeDomainData(dataArray);
                            let sum = 0;
                            let max = 0;
                            for (let i = 0; i < bufferLength; i++) {
                                const amplitude = Math.abs(dataArray[i] - 128);
                                sum += amplitude;
                                if (amplitude > max) max = amplitude;
                            }
                            
                            // ãƒã‚¤ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° - åŸºæº–å€¤ä»¥ä¸‹ã¯ã‚«ãƒƒãƒˆ
                            const noiseThreshold = 3; // ãƒã‚¤ã‚ºãƒ¬ãƒ™ãƒ«
                            const adjustedMax = max > noiseThreshold ? max - noiseThreshold : 0;
                            
                            // ã‚ˆã‚Šé©åˆ‡ãªæ„Ÿåº¦è¨ˆç®—ï¼ˆãƒã‚¤ã‚ºã‚’è€ƒæ…®ï¼‰
                            const levelPercent = Math.min((adjustedMax / 50) * 100, 100);
                            document.getElementById('mic-level-bar').style.width = levelPercent + '%';
                            document.getElementById('mic-level-text').textContent = Math.round(levelPercent) + '%';
                            
                            // å®Ÿéš›ã®éŸ³å£°ã®ã¿ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒã‚¤ã‚ºé™¤å¤–ï¼‰
                            if (levelPercent > 10) {
                                console.log('éŸ³å£°ãƒ¬ãƒ™ãƒ«æ¤œå‡º:', levelPercent + '%', '(Raw:', max, 'Adjusted:', adjustedMax, ')');
                            }
                            
                            requestAnimationFrame(updateMicLevel);
                        }
                        updateMicLevel();
                        
                        if (!deviceInfo.isIOS) {
                            gameState.recognition = initSpeechRecognition();
                            if (!gameState.recognition) {
                                testStatus.className = 'test-status error';
                                testStatus.textContent = 'âŒ éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“';
                                updateDebugInfo('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼', '', 'ã‚¨ãƒ©ãƒ¼: ã‚µãƒãƒ¼ãƒˆãªã—', 'æ¥ç¶šæ¸ˆã¿');
                                return;
                            }
                        }

                        console.log('éŸ³å£°èªè­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†:', gameState.recognition);
                        setupTestButton(stream);
                        
                    } catch (audioError) {
                        console.error('AudioContext ã‚¨ãƒ©ãƒ¼:', audioError);
                        testStatus.className = 'test-status error';
                        testStatus.textContent = 'âŒ éŸ³å£°å‡¦ç†ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + audioError.message;
                        updateDebugInfo('éŸ³å£°å‡¦ç†ã‚¨ãƒ©ãƒ¼', '', 'ã‚¨ãƒ©ãƒ¼: ' + audioError.message, 'ã‚¨ãƒ©ãƒ¼');
                    }
                })
                .catch(err => {
                    console.error('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', err);
                    testStatus.className = 'test-status error';
                    
                    let errorMessage = 'âŒ ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ';
                    if (err.name === 'NotAllowedError') {
                        if (deviceInfo.isIOS) {
                            errorMessage += 'iPhoneã®è¨­å®šã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚è¨­å®š > Safari > ãƒã‚¤ã‚¯ > è¨±å¯';
                        } else {
                            errorMessage += 'ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
                        }
                    } else {
                        errorMessage += err.message;
                    }
                    
                    testStatus.textContent = errorMessage;
                    updateDebugInfo('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼', '', 'ã‚¨ãƒ©ãƒ¼: ' + err.name, 'ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦');
                });
        }

        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupTestButton(stream) {
            const testBtn = document.getElementById('test-mic-btn');
            
            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å®Œå…¨ã«å‰Šé™¤
            testBtn.replaceWith(testBtn.cloneNode(true));
            const newTestBtn = document.getElementById('test-mic-btn');
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ç®¡ç†
            let isButtonProcessing = false;
            
            newTestBtn.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                // å‡¦ç†ä¸­ã®å ´åˆã¯ç„¡è¦–
                if (isButtonProcessing) {
                    console.log('ãƒœã‚¿ãƒ³å‡¦ç†ä¸­ã®ãŸã‚ç„¡è¦–');
                    return;
                }
                
                console.log('ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - ç¾åœ¨ã®éŒ²éŸ³çŠ¶æ…‹:', gameState.isRecording);
                
                if (newTestBtn.disabled) {
                    console.log('ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                    return;
                }
                
                // å‡¦ç†ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                isButtonProcessing = true;
                newTestBtn.disabled = true;
                
                if (gameState.isRecording) {
                    console.log('éŒ²éŸ³åœæ­¢å‡¦ç†é–‹å§‹');
                    if (gameState.recognition) {
                        gameState.recognition.stop();
                    }
                } else {
                    console.log('éŒ²éŸ³é–‹å§‹å‡¦ç†é–‹å§‹');
                    startSpeechRecognition();
                }
                
                // 5ç§’å¾Œã«ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
                setTimeout(() => {
                    newTestBtn.disabled = false;
                    isButtonProcessing = false;
                    console.log('ãƒœã‚¿ãƒ³ãŒå†æœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ');
                }, 5000);
            });
        }

        // éŸ³å£°èªè­˜é–‹å§‹
        function startSpeechRecognition() {
            if (!gameState.recognition) {
                console.error('éŸ³å£°èªè­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                return;
            }

            if (gameState.isRecording) {
                console.log('æ—¢ã«éŒ²éŸ³ä¸­ã§ã™');
                return;
            }

            try {
                console.log('éŸ³å£°èªè­˜é–‹å§‹è©¦è¡Œ');
                updateDebugInfo('é–‹å§‹ä¸­...', '', 'éŒ²éŸ³é–‹å§‹è©¦è¡Œ', 'æ¥ç¶šæ¸ˆã¿ãƒ»é–‹å§‹ä¸­');
                
                setupSpeechRecognitionEvents();
                
                gameState.recognition.start();
                gameState.isRecording = true;
                console.log('éŸ³å£°èªè­˜é–‹å§‹æˆåŠŸ');
                
            } catch (error) {
                console.error('éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('test-status').textContent = 'âŒ éŸ³å£°èªè­˜ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + error.message;
                updateDebugInfo('é–‹å§‹ã‚¨ãƒ©ãƒ¼', '', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'æ¥ç¶šæ¸ˆã¿ãƒ»ã‚¨ãƒ©ãƒ¼');
                gameState.isRecording = false;
            }
        }

        // éŸ³å£°èªè­˜ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
        function setupSpeechRecognitionEvents() {
            const testBtn = document.getElementById('test-mic-btn');
            const testStatus = document.getElementById('test-status');
            const testRecognition = document.getElementById('test-recognition');
            const startGameBtn = document.getElementById('start-game-btn');

            gameState.recognition.onstart = () => {
                console.log('éŸ³å£°èªè­˜é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆ');
                testBtn.classList.add('recording');
                testBtn.textContent = 'ğŸ”´';
                testStatus.className = 'test-status';
                testStatus.textContent = 'ğŸ¤ èã„ã¦ã„ã¾ã™... ã€Œãƒ†ã‚¹ãƒˆã€ã¨è¨€ã£ã¦ãã ã•ã„';
                testRecognition.textContent = 'éŸ³å£°ã‚’èªè­˜ä¸­...';
                updateDebugInfo('èªè­˜ä¸­...', '', 'éŸ³å£°èªè­˜å®Ÿè¡Œä¸­', 'æ¥ç¶šæ¸ˆã¿ãƒ»èªè­˜ä¸­');
            };

            gameState.recognition.onresult = (event) => {
                console.log('éŸ³å£°èªè­˜çµæœã‚¤ãƒ™ãƒ³ãƒˆ:', event);
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    const confidence = event.results[i][0].confidence;
                    console.log(`çµæœ ${i}:`, transcript, 'Confidence:', confidence, 'Final:', event.results[i].isFinal);
                    
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                updateDebugInfo(
                    interimTranscript || 'ï¼ˆèªè­˜ä¸­...ï¼‰',
                    finalTranscript || 'ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰',
                    'èªè­˜çµæœã‚’å–å¾—ä¸­',
                    'æ¥ç¶šæ¸ˆã¿ãƒ»èªè­˜ä¸­'
                );

                const displayText = finalTranscript || interimTranscript || 'éŸ³å£°ã‚’èªè­˜ä¸­...';
                testRecognition.textContent = displayText;

                if (finalTranscript) {
                    console.log('ç¢ºå®šã•ã‚ŒãŸè¨€è‘‰:', finalTranscript);
                    
                    const normalizedFinal = finalTranscript.replace(/\s/g, '');
                    const isTestWord = normalizedFinal.includes('ãƒ†ã‚¹ãƒˆ') || normalizedFinal.includes('test');
                    
                    if (isTestWord) {
                        console.log('ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ãƒ‰æ¤œå‡ºï¼:', finalTranscript);
                        testStatus.className = 'test-status success';
                        testStatus.textContent = 'âœ… ãƒã‚¤ã‚¯ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™ã€‚';
                        startGameBtn.disabled = false;
                        updateDebugInfo(
                            interimTranscript,
                            finalTranscript + ' â† ã€Œãƒ†ã‚¹ãƒˆã€ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼',
                            'èªè­˜æˆåŠŸï¼',
                            'æ¥ç¶šæ¸ˆã¿ãƒ»ãƒ†ã‚¹ãƒˆå®Œäº†'
                        );
                        
                        setTimeout(() => {
                            if (gameState.recognition && gameState.isRecording) {
                                gameState.recognition.stop();
                            }
                        }, 2000);
                    }
                }
            };

            gameState.recognition.onaudiostart = () => {
                console.log('éŸ³å£°å…¥åŠ›é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆ');
                updateDebugInfo('éŸ³å£°å…¥åŠ›æ¤œå‡º', '', 'éŸ³å£°å…¥åŠ›é–‹å§‹', 'æ¥ç¶šæ¸ˆã¿ãƒ»éŸ³å£°æ¤œå‡º');
                
                if (gameState.currentScreen === 'mic-test-screen') {
                    testStatus.textContent = 'ğŸ¤ éŸ³å£°ã‚’æ¤œå‡ºä¸­... ãã®ã¾ã¾ã€Œãƒ†ã‚¹ãƒˆã€ã¨è¨€ã£ã¦ãã ã•ã„';
                }
            };

            gameState.recognition.onsoundstart = () => {
                console.log('éŸ³å£°æ¤œå‡ºé–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆ');
                updateDebugInfo('éŸ³å£°æ¤œå‡ºä¸­', '', 'éŸ³å£°æ¤œå‡ºä¸­', 'æ¥ç¶šæ¸ˆã¿ãƒ»éŸ³å£°ã‚ã‚Š');
            };

            gameState.recognition.onspeechstart = () => {
                console.log('ç™ºè©±é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆ');
                updateDebugInfo('ç™ºè©±æ¤œå‡º', '', 'ç™ºè©±èªè­˜ä¸­', 'æ¥ç¶šæ¸ˆã¿ãƒ»ç™ºè©±ä¸­');
                
                if (gameState.currentScreen === 'mic-test-screen') {
                    testStatus.textContent = 'ğŸ—£ï¸ ç™ºè©±ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼èªè­˜ä¸­...';
                    testRecognition.textContent = 'è¨€è‘‰ã‚’èªè­˜ã—ã¦ã„ã¾ã™...';
                }
            };

            gameState.recognition.onnomatch = () => {
                console.log('èªè­˜çµæœãªã—ã‚¤ãƒ™ãƒ³ãƒˆ');
                updateDebugInfo('èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ', '', 'èªè­˜çµæœãªã—', 'æ¥ç¶šæ¸ˆã¿');
            };

            gameState.recognition.onerror = (event) => {
                console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ:', event.error, event);
                
                if (event.error === 'service-not-allowed') {
                    testStatus.className = 'test-status error';
                    testStatus.textContent = 'âŒ iPhoneéŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã€æ©Ÿå†…ãƒ¢ãƒ¼ãƒ‰ãŒOFFã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    updateDebugInfo('service-not-allowed ã‚¨ãƒ©ãƒ¼', '', 'ã‚¨ãƒ©ãƒ¼: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œ', 'iPhoneç‰¹æœ‰ã‚¨ãƒ©ãƒ¼');
                    
                    testBtn.classList.remove('recording');
                    testBtn.textContent = 'ğŸ¤';
                    gameState.isRecording = false;
                    return;
                }
                
                if (event.error === 'no-speech' && gameState.isRecording) {
                    console.log('no-speechã‚¨ãƒ©ãƒ¼ - è‡ªå‹•å†é–‹ã‚’è©¦è¡Œã—ã¾ã™');
                    testStatus.className = 'test-status';
                    testStatus.textContent = 'ğŸ”„ éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ã‚¯ã«è¿‘ã¥ã„ã¦å¤§ããªå£°ã§ã€Œãƒ†ã‚¹ãƒˆã€ã¨è¨€ã£ã¦ãã ã•ã„';
                    updateDebugInfo('éŸ³å£°æ¤œå‡ºã•ã‚Œãš - å†è©¦è¡Œä¸­', '', 'è‡ªå‹•å†é–‹ä¸­', 'æ¥ç¶šæ¸ˆã¿ãƒ»å†è©¦è¡Œ');
                    
                    setTimeout(() => {
                        if (gameState.isRecording && gameState.recognition) {
                            try {
                                console.log('è‡ªå‹•å†é–‹å®Ÿè¡Œ');
                                gameState.recognition.start();
                            } catch (restartError) {
                                console.error('è‡ªå‹•å†é–‹ã‚¨ãƒ©ãƒ¼:', restartError);
                            }
                        }
                    }, 1000);
                    return;
                }

                testStatus.className = 'test-status error';
                let errorMessage = 'âŒ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ';
                switch(event.error) {
                    case 'no-speech':
                        errorMessage += 'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ã‚¯ã«è¿‘ã¥ã„ã¦å¤§ããªå£°ã§è©±ã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'audio-capture':
                        errorMessage += 'ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚';
                        break;
                    case 'not-allowed':
                        errorMessage += 'ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚';
                        break;
                    case 'network':
                        errorMessage += 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        break;
                    case 'service-not-allowed':
                        errorMessage += 'éŸ³å£°èªè­˜ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        break;
                    default:
                        errorMessage += event.error;
                }
                testStatus.textContent = errorMessage;
                updateDebugInfo('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', '', 'ã‚¨ãƒ©ãƒ¼: ' + event.error, 'æ¥ç¶šæ¸ˆã¿ãƒ»ã‚¨ãƒ©ãƒ¼');
                
                testBtn.classList.remove('recording');
                testBtn.textContent = 'ğŸ¤';
                gameState.isRecording = false;
            };

            gameState.recognition.onend = () => {
                console.log('éŸ³å£°èªè­˜çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆ');
                testBtn.classList.remove('recording');
                testBtn.textContent = 'ğŸ¤';
                updateDebugInfo('éŸ³å£°èªè­˜çµ‚äº†', '', 'çµ‚äº†', 'æ¥ç¶šæ¸ˆã¿ãƒ»åœæ­¢');
                gameState.isRecording = false;
                
                // ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–ã‚’è§£é™¤ï¼ˆéŸ³å£°èªè­˜çµ‚äº†æ™‚ï¼‰
                setTimeout(() => {
                    testBtn.disabled = false;
                    console.log('éŸ³å£°èªè­˜çµ‚äº†ã«ã‚ˆã‚Šãƒœã‚¿ãƒ³å†æœ‰åŠ¹åŒ–');
                }, 1000);
            };
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            const shuffled = [...QUESTIONS].sort(() => 0.5 - Math.random());
            gameState.selectedQuestions = shuffled.slice(0, 15);
            gameState.currentQuestion = 0;
            gameState.totalScore = 0;
            gameState.results = [];

            showScreen('game-screen');
            showNextQuestion();
        }

        // æ¬¡ã®å•é¡Œè¡¨ç¤º
        function showNextQuestion() {
            if (gameState.currentQuestion >= gameState.selectedQuestions.length) {
                endGame();
                return;
            }

            const question = gameState.selectedQuestions[gameState.currentQuestion];
            document.getElementById('question-text').textContent = question.text;
            document.getElementById('current-question').textContent = gameState.currentQuestion + 1;
            document.getElementById('current-score').textContent = gameState.totalScore;
            document.getElementById('recognition-text').innerHTML = '';
            
            const progress = ((gameState.currentQuestion) / gameState.selectedQuestions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';

            gameState.timeLeft = 15;
            document.getElementById('timer').textContent = gameState.timeLeft;
            
            const micBtn = document.getElementById('game-mic-btn');
            micBtn.classList.remove('recording');
            micBtn.textContent = 'ğŸ¤';
            micBtn.disabled = false;

            gameState.questionStartTime = Date.now();
            startQuestionTimer();
        }

        // å•é¡Œã‚¿ã‚¤ãƒãƒ¼
        function startQuestionTimer() {
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    skipQuestion();
                }
            }, 1000);
        }

        // éŒ²éŸ³é–‹å§‹
        function startRecording() {
            if (gameState.isRecording) {
                stopRecording();
                return;
            }

            gameState.recognition = initSpeechRecognition();
            if (!gameState.recognition) return;

            const micBtn = document.getElementById('game-mic-btn');
            const recognitionText = document.getElementById('recognition-text');
            const currentQuestion = gameState.selectedQuestions[gameState.currentQuestion];

            gameState.isRecording = true;
            micBtn.classList.add('recording');
            micBtn.textContent = 'â¹ï¸';

            gameState.recognition.onstart = () => {
                recognitionText.textContent = 'èã„ã¦ã„ã¾ã™...';
            };

            gameState.recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const debugSpeech = document.getElementById('game-debug-speech');
                if (debugSpeech) {
                    const currentText = finalTranscript || interimTranscript || 'èªè­˜ä¸­...';
                    debugSpeech.textContent = `ã€Œ${currentText}ã€${finalTranscript ? ' (ç¢ºå®š)' : ' (èªè­˜ä¸­)'}`;
                }

                const displayText = finalTranscript || interimTranscript;
                displayRecognitionResult(displayText, currentQuestion.text);

                if (finalTranscript) {
                    const timeSpent = (Date.now() - gameState.questionStartTime) / 1000;
                    const result = calculateScore(finalTranscript, currentQuestion, timeSpent);
                    gameState.results.push(result);
                    gameState.totalScore += result.score;

                    clearInterval(gameState.timer);
                    stopRecording();
                    
                    setTimeout(() => {
                        gameState.currentQuestion++;
                        showNextQuestion();
                    }, 1500);
                }
            };

            gameState.recognition.onerror = (event) => {
                console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
                recognitionText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                stopRecording();
            };

            gameState.recognition.start();
        }

        // éŒ²éŸ³åœæ­¢
        function stopRecording() {
            if (gameState.recognition) {
                gameState.recognition.stop();
            }
            gameState.isRecording = false;
            
            const micBtn = document.getElementById('game-mic-btn');
            micBtn.classList.remove('recording');
            micBtn.textContent = 'ğŸ¤';
        }

        // èªè­˜çµæœã®è¡¨ç¤ºï¼ˆæ–‡å­—è‰²åˆ†ã‘ï¼‰
        function displayRecognitionResult(userText, correctText) {
            const recognitionDiv = document.getElementById('recognition-text');
            const userChars = userText.split('');
            const correctChars = correctText.split('');
            
            let html = '';
            const maxLength = Math.max(userChars.length, correctChars.length);
            
            for (let i = 0; i < maxLength; i++) {
                const userChar = userChars[i] || '';
                const correctChar = correctChars[i] || '';
                
                let className = 'char ';
                if (i < userChars.length && i < correctChars.length) {
                    className += userChar === correctChar ? 'correct' : 'incorrect';
                } else if (i >= userChars.length) {
                    className += 'pending';
                } else {
                    className += 'incorrect';
                }
                
                html += `<span class="${className}">${userChar || correctChar}</span>`;
            }
            
            recognitionDiv.innerHTML = html;
        }

        // ã‚¹ã‚³ã‚¢è¨ˆç®—
        function calculateScore(userText, question, timeSpent) {
            const correctText = question.text;
            const userChars = userText.split('');
            const correctChars = correctText.split('');
            
            let correctCount = 0;
            const minLength = Math.min(userChars.length, correctChars.length);
            
            for (let i = 0; i < minLength; i++) {
                if (userChars[i] === correctChars[i]) {
                    correctCount++;
                }
            }
            
            const accuracy = correctChars.length > 0 ? (correctCount / correctChars.length) * 100 : 0;
            
            let timeBonus = 1.0;
            if (timeSpent <= 5) timeBonus = 1.5;
            else if (timeSpent <= 10) timeBonus = 1.2;
            else if (timeSpent <= 15) timeBonus = 1.0;
            else timeBonus = 0.8;
            
            const score = Math.round(question.baseScore * (accuracy / 100) * timeBonus);
            
            return {
                questionId: question.id,
                questionText: question.text,
                userText: userText,
                accuracy: Math.round(accuracy),
                timeSpent: Math.round(timeSpent * 10) / 10,
                score: Math.max(0, score),
                baseScore: question.baseScore,
                timeBonus: timeBonus
            };
        }

        // å•é¡Œã‚¹ã‚­ãƒƒãƒ—
        function skipQuestion() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            const currentQuestion = gameState.selectedQuestions[gameState.currentQuestion];
            const result = {
                questionId: currentQuestion.id,
                questionText: currentQuestion.text,
                userText: 'ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰',
                accuracy: 0,
                timeSpent: 15,
                score: 0,
                baseScore: currentQuestion.baseScore,
                timeBonus: 0.8
            };
            
            gameState.results.push(result);
            stopRecording();
            
            gameState.currentQuestion++;
            showNextQuestion();
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†
        function endGame() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            stopRecording();
            showResults();
        }

        // çµæœè¡¨ç¤º
        function showResults() {
            showScreen('result-screen');
            
            const totalQuestions = gameState.results.length;
            const correctAnswers = gameState.results.filter(r => r.accuracy >= 80).length;
            const accuracyRate = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            const averageTime = totalQuestions > 0 ? 
                Math.round((gameState.results.reduce((sum, r) => sum + r.timeSpent, 0) / totalQuestions) * 10) / 10 : 0;

            document.getElementById('final-score').textContent = gameState.totalScore + 'ç‚¹';
            document.getElementById('player-result-name').textContent = gameState.playerName;
            document.getElementById('accuracy-rate').textContent = accuracyRate;
            document.getElementById('average-time').textContent = averageTime;
            document.getElementById('completed-questions').textContent = totalQuestions;

            const detailedResults = document.getElementById('detailed-results');
            detailedResults.innerHTML = '<h3>è©³ç´°çµæœ</h3>';
            
            gameState.results.forEach((result, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                
                const accuracy = result.accuracy >= 80 ? 'âœ…' : result.accuracy >= 50 ? 'âš ï¸' : 'âŒ';
                
                resultItem.innerHTML = `
                    <div>
                        <strong>å•é¡Œ${index + 1}:</strong> ${result.questionText}<br>
                        <small>ã‚ãªãŸã®å›ç­”: ${result.userText}</small>
                    </div>
                    <div style="text-align: right;">
                        ${accuracy} ${result.accuracy}%<br>
                        <strong>${result.score}ç‚¹</strong>
                    </div>
                `;
                
                detailedResults.appendChild(resultItem);
            });
        }

        // ã‚²ãƒ¼ãƒ å†é–‹å§‹
        function restartGame() {
            resetGameState();
            startGame();
        }

        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            const deviceInfo = checkDeviceSupport();
            
            if (!deviceInfo.speechSupported) {
                let message = '<div class="container"><h1>âŒ éŸ³å£°èªè­˜éå¯¾å¿œ</h1>';
                
                if (deviceInfo.isIOS) {
                    message += `
                        <p>iOSãƒ‡ãƒã‚¤ã‚¹ã§ã¯<strong>Safari</strong>ã®ã¿éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</p>
                        <p>Safariã§ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãç›´ã—ã¦ãã ã•ã„ã€‚</p>
                    `;
                } else if (deviceInfo.isAndroid) {
                    message += `
                        <p>Androidãƒ‡ãƒã‚¤ã‚¹ã§ã¯<strong>Chrome</strong>ã§éŸ³å£°èªè­˜ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
                    `;
                } else {
                    message += `
                        <p>ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚</p>
                        <p>ä»¥ä¸‹ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ãŠè©¦ã—ãã ã•ã„ï¼š</p>
                        <ul style="text-align: left; max-width: 300px; margin: 20px auto;">
                            <li>Google Chromeï¼ˆæ¨å¥¨ï¼‰</li>
                            <li>Microsoft Edge</li>
                            <li>Safariï¼ˆMac/iOSï¼‰</li>
                        </ul>
                    `;
                }
                
                message += '</div>';
                document.body.innerHTML = message;
                return;
            }

            console.log('éŸ³å£°èªè­˜å¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œå‡º:', deviceInfo);
            
            if (deviceInfo.isMobile) {
                console.log('ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹å‘ã‘æœ€é©åŒ–ã‚’é©ç”¨');
                document.body.style.overflow = 'hidden';
                document.body.style.height = '100vh';
                
                if (deviceInfo.isIOS && deviceInfo.isSafari) {
                    console.log('iOS Safariå‘ã‘æœ€é©åŒ–ã‚’é©ç”¨');
                }
            }

            document.getElementById('player-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startMicTest();
                }
            });
        });

        window.addEventListener('beforeunload', function() {
            if (gameState.recognition) {
                gameState.recognition.stop();
            }
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
        });

        document.addEventListener('keydown', function(e) {
            if (gameState.currentScreen === 'game-screen') {
                if (e.code === 'Space') {
                    e.preventDefault();
                    startRecording();
                } else if (e.code === 'Escape') {
                    e.preventDefault();
                    skipQuestion();
                }
            }
        });
    </script>
</body>
</html>
